<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { margin: 0; padding: 0; }
        poline-picker {
            width: 100%;
            height: 100%;
            display: block;
            --poline-picker-line-color: #333;
            --poline-picker-bg-color: #fff;
        }
    </style>
</head>
<body>
    <poline-picker id="picker" interactive allow-add-points></poline-picker>
    
    <script type="module">
        import { Poline, PolinePicker } from 'https://unpkg.com/poline/dist/picker.mjs';
        
        const picker = document.getElementById('picker');
        
        // Store current poline config for steps updates
        let currentConfig = {
            anchorColors: [[0, 0.8, 0.6], [180, 0.7, 0.4]],
            numPoints: 5
        };
        
        // Default poline using currentConfig
        const poline = new Poline(currentConfig);
        picker.setPoline(poline);
        
        // Listen for changes and update the poline palette display
        picker.addEventListener('poline-change', (event) => {
            const { poline } = event.detail;
            const polineColors = [...poline.colors]; // Raw HSL array [h, s, l]
            window.parent.postMessage({ type: 'poline-colors-update', polineColors }, '*');
        });
        
        // Listen for updates from parent
        window.addEventListener('message', (event) => {
            if (event.data.type === 'update-poline') {
                const newPoline = new Poline(event.data.config);
                currentConfig = event.data.config;
                picker.setPoline(newPoline);
            } else if (event.data.type === 'update-steps') {
                // Update number of intermediate points while keeping anchor colors fixed
                // Steps = total colors including anchors, so intermediate points = steps - 2
                const newNumPoints = Math.max(0, event.data.steps - 2);
                
                // Keep the same anchor colors, only change intermediate points
                const updatedConfig = {
                    ...currentConfig,
                    numPoints: newNumPoints
                };
                
                const updatedPoline = new Poline(updatedConfig);
                picker.setPoline(updatedPoline);
                
                // Update currentConfig to reflect the change
                currentConfig = updatedConfig;
                
                // Send updated colors immediately
                const polineColors = [...updatedPoline.colors];
                window.parent.postMessage({ type: 'poline-colors-update', polineColors }, '*');
            } else if (event.data.type === 'set-ai-colors') {
                // Convert AI hex colors to HSL for poline
                const anchorColors = event.data.colors.map(color => {
                    const r = parseInt(color.hex.slice(1, 3), 16) / 255;
                    const g = parseInt(color.hex.slice(3, 5), 16) / 255;
                    const b = parseInt(color.hex.slice(5, 7), 16) / 255;
                    
                    const max = Math.max(r, g, b);
                    const min = Math.min(r, g, b);
                    let h, s, l = (max + min) / 2;
                    
                    if (max === min) {
                        h = s = 0;
                    } else {
                        const d = max - min;
                        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                        switch (max) {
                            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                            case g: h = (b - r) / d + 2; break;
                            case b: h = (r - g) / d + 4; break;
                        }
                        h /= 6;
                    }
                    
                    return [h * 360, s, l];
                });
                
                // Use first and middle colors as anchor points
                const numColors = event.data.colors.length;
                let selectedAnchors;
                
                if (numColors >= 3) {
                    const middleIndex = Math.floor(numColors / 2);
                    selectedAnchors = [anchorColors[0], anchorColors[middleIndex]];
                } else if (numColors === 2) {
                    selectedAnchors = [anchorColors[0], anchorColors[1]];
                } else {
                    selectedAnchors = [anchorColors[0], [anchorColors[0][0] + 180, anchorColors[0][1], anchorColors[0][2]]];
                }
                
                // Update current config with AI colors
                // Keep the anchor colors fixed and set intermediate points
                currentConfig = {
                    anchorColors: selectedAnchors,
                    numPoints: Math.max(0, numColors - 2)
                };
                
                const aiPoline = new Poline(currentConfig);
                picker.setPoline(aiPoline);
            } else if (event.data.type === 'request-colors') {
                // Send current colors to parent
                const poline = picker.getPoline();
                const polineColors = [...poline.colors]; // Raw HSL array [h, s, l]
                window.parent.postMessage({ type: 'poline-colors-update', polineColors }, '*');
            }
        });
    </script>
</body>
</html>
